import{_ as s,v as n,b as a,R as l}from"./chunks/framework.70afa331.js";const p="/assets/win1.7d3fc058.png",o="/assets/win2.72bb0e48.jpg",e="/assets/win3.442eb15f.jpg",t="/assets/win4.75bd03c1.jpg",h=JSON.parse('{"title":"在 Incus 中运行 Windows 虚拟机","description":"","frontmatter":{"outline":"deep"},"headers":[],"relativePath":"guide/incus/incus_windows.md","filePath":"guide/incus/incus_windows.md","lastUpdated":1747752093000}'),c={name:"guide/incus/incus_windows.md"},r=l(`<h1 id="在-incus-中运行-windows-虚拟机" tabindex="-1">在 Incus 中运行 Windows 虚拟机 <a class="header-anchor" href="#在-incus-中运行-windows-虚拟机" aria-label="Permalink to &quot;在 Incus 中运行 Windows 虚拟机&quot;">​</a></h1><h2 id="检查-incus-驱动" tabindex="-1">检查 Incus 驱动 <a class="header-anchor" href="#检查-incus-驱动" aria-label="Permalink to &quot;检查 Incus 驱动&quot;">​</a></h2><p>确保 <code>incus info</code> 输出中含有 <code>qemu</code>，否则无法创建 VM：</p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">incus</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">info</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">grep</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-i</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">driver:</span></span></code></pre></div><p>若显示只有 <code>lxc</code>，则incus的驱动不支持开设虚拟机，不需要看后续的教程了。</p><h2 id="准备环境和修补镜像" tabindex="-1">准备环境和修补镜像 <a class="header-anchor" href="#准备环境和修补镜像" aria-label="Permalink to &quot;准备环境和修补镜像&quot;">​</a></h2><p>在 <code>/root</code> 目录下按顺序执行以下命令：</p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">apt</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">update</span></span>
<span class="line"><span style="color:#FFCB6B;">apt</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">install</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-y</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">snapd</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">libguestfs-tools</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">wimtools</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">rsync</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">libhivex-bin</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">libwin-hivex-perl</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">genisoimage</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">||</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">apt</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">install</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-y</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">mkisofs</span></span>
<span class="line"><span style="color:#FFCB6B;">snap</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">install</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">distrobuilder</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--classic</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 重启加载一些配置</span></span>
<span class="line"><span style="color:#FFCB6B;">reboot</span></span></code></pre></div><p>下载镜像并进行修补，如果你使用的是别的镜像，自行替换下载链接(不需要下载自带virtio的镜像，原始的镜像就够了)</p><p>自行下载Windows镜像的地址：<a href="https://down.idc.wiki/ISOS/Windows/" target="_blank" rel="noreferrer">https://down.idc.wiki/ISOS/Windows/</a></p><p>支持修补的Windows镜像版本：<a href="https://linuxcontainers.org/distrobuilder/docs/latest/tutorials/use/#repack-windows-iso" target="_blank" rel="noreferrer">https://linuxcontainers.org/distrobuilder/docs/latest/tutorials/use/#repack-windows-iso</a></p><p>下面的指南将以windows2019作为示例进行</p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">wget</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">https://down.idc.wiki/ISOS/Windows/Server%202019/cn_windows_server_2019_updated_july_2020_x64_dvd_2c9b67da.iso</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-O</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">win.iso</span></span>
<span class="line"><span style="color:#FFCB6B;">distrobuilder</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">repack-windows</span><span style="color:#A6ACCD;"> \\</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">--windows-arch=amd64</span><span style="color:#A6ACCD;"> \\</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">win.iso</span><span style="color:#A6ACCD;"> \\</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">win.incus.iso</span></span></code></pre></div><p>修补时长取决于程序何时正确添加启动所需的驱动(未成功时会一个个尝试直到成功)，有的耗时短有的耗时长，最长可能超过30分钟，建议在<code>screen</code>或<code>tmux</code>中挂起执行</p><p>修补完毕后可删除原始的镜像：</p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">rm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-f</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">win.iso</span></span></code></pre></div><h2 id="创建虚拟机并挂载安装iso" tabindex="-1">创建虚拟机并挂载安装ISO <a class="header-anchor" href="#创建虚拟机并挂载安装iso" aria-label="Permalink to &quot;创建虚拟机并挂载安装ISO&quot;">​</a></h2><p>这里我使用的配置是3核5G内存30G硬盘，如果使用的是windows10等更新版本的镜像，至少需要4核6G内存40G硬盘。</p><p>建议使用比我现在设置的资源更多的CPU和内存(主要是内存)，避免系统卡到崩溃。</p><p>如果内存不够用，建议查看本指南的其他实用项目中的添加SWAP项目，自行添加更多虚拟内存。</p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;"># 初始化空 VM</span></span>
<span class="line"><span style="color:#FFCB6B;">incus</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">init</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">winvm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--empty</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--vm</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 调整根盘大小、CPU、内存</span></span>
<span class="line"><span style="color:#FFCB6B;">incus</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">config</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">device</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">override</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">winvm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">root</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">size=</span><span style="color:#F78C6C;">30</span><span style="color:#C3E88D;">GiB</span></span>
<span class="line"><span style="color:#FFCB6B;">incus</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">config</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">set</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">winvm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">limits.cpu=</span><span style="color:#F78C6C;">3</span></span>
<span class="line"><span style="color:#FFCB6B;">incus</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">config</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">set</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">winvm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">limits.memory=</span><span style="color:#F78C6C;">5</span><span style="color:#C3E88D;">GiB</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 添加 TPM 设备（Secure Boot/BitLocker 支持）</span></span>
<span class="line"><span style="color:#FFCB6B;">incus</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">config</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">device</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">add</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">winvm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">vtpm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">tpm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">path=/dev/tpm0</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 挂载安装 ISO，设为第一启动项</span></span>
<span class="line"><span style="color:#FFCB6B;">incus</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">config</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">device</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">add</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">winvm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">install</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">disk</span><span style="color:#A6ACCD;"> \\</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">source=/root/win.incus.iso</span><span style="color:#A6ACCD;"> \\</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">boot.priority=</span><span style="color:#F78C6C;">10</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 配置静态IPV4地址</span></span>
<span class="line"><span style="color:#A6ACCD;">DEV</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">$(</span><span style="color:#FFCB6B;">lshw</span><span style="color:#C3E88D;"> -C network </span><span style="color:#89DDFF;">|</span><span style="color:#C3E88D;"> </span><span style="color:#FFCB6B;">awk</span><span style="color:#C3E88D;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">/logical name:/{print $3}</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;"> </span><span style="color:#89DDFF;">|</span><span style="color:#C3E88D;"> </span><span style="color:#FFCB6B;">head</span><span style="color:#C3E88D;"> -1</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">CIDR</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">$(</span><span style="color:#FFCB6B;">incus</span><span style="color:#C3E88D;"> network show incusbr0 </span><span style="color:#89DDFF;">|</span><span style="color:#C3E88D;"> </span><span style="color:#FFCB6B;">awk</span><span style="color:#C3E88D;"> -F: </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">/ipv4.address/ {gsub(/ /,&quot;&quot;,$2); print $2}</span><span style="color:#89DDFF;">&#39;)</span></span>
<span class="line"><span style="color:#A6ACCD;">PREFIX</span><span style="color:#89DDFF;">=\${</span><span style="color:#A6ACCD;">CIDR</span><span style="color:#89DDFF;">%/*}</span><span style="color:#A6ACCD;">             </span></span>
<span class="line"><span style="color:#A6ACCD;">PLEN</span><span style="color:#89DDFF;">=\${</span><span style="color:#A6ACCD;">CIDR</span><span style="color:#89DDFF;">#*/}</span><span style="color:#A6ACCD;">              </span></span>
<span class="line"><span style="color:#A6ACCD;">BASE</span><span style="color:#89DDFF;">=\${</span><span style="color:#A6ACCD;">PREFIX</span><span style="color:#89DDFF;">%</span><span style="color:#A6ACCD;">.</span><span style="color:#89DDFF;">*}</span><span style="color:#A6ACCD;">            </span></span>
<span class="line"><span style="color:#A6ACCD;">START</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;">                      </span></span>
<span class="line"><span style="color:#A6ACCD;">END</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">$((</span><span style="color:#C3E88D;"> </span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">**</span><span style="color:#C3E88D;">(</span><span style="color:#F78C6C;">32</span><span style="color:#89DDFF;">-</span><span style="color:#C3E88D;">PLEN) </span><span style="color:#89DDFF;">-</span><span style="color:#C3E88D;"> </span><span style="color:#F78C6C;">2</span><span style="color:#C3E88D;"> </span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#A6ACCD;">USED</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">$(</span><span style="color:#FFCB6B;">incus</span><span style="color:#C3E88D;"> network list-leases incusbr0 </span><span style="color:#89DDFF;">|</span><span style="color:#C3E88D;"> </span><span style="color:#FFCB6B;">awk</span><span style="color:#C3E88D;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">{print $2}</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;"> </span><span style="color:#89DDFF;">|</span><span style="color:#C3E88D;"> </span><span style="color:#FFCB6B;">grep</span><span style="color:#C3E88D;"> -E </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">^</span><span style="color:#89DDFF;">\${</span><span style="color:#A6ACCD;">BASE</span><span style="color:#89DDFF;">}</span><span style="color:#C3E88D;">\\.</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;"> </span><span style="color:#89DDFF;">||</span><span style="color:#C3E88D;"> </span><span style="color:#82AAFF;">true</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;font-style:italic;">in</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">$(</span><span style="color:#FFCB6B;">seq</span><span style="color:#C3E88D;"> </span><span style="color:#A6ACCD;">$START</span><span style="color:#C3E88D;"> </span><span style="color:#A6ACCD;">$END</span><span style="color:#89DDFF;">)</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">do</span></span>
<span class="line"><span style="color:#A6ACCD;">    IP</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;\${</span><span style="color:#A6ACCD;">BASE</span><span style="color:#89DDFF;">}</span><span style="color:#C3E88D;">.</span><span style="color:#89DDFF;">\${</span><span style="color:#A6ACCD;">i</span><span style="color:#89DDFF;">}&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">!</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">grep</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-qx</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">$IP</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&lt;&lt;&lt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">$USED</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">then</span></span>
<span class="line"><span style="color:#A6ACCD;">        FREE_IP</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">$IP</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">break</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">fi</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">done</span></span>
<span class="line"><span style="color:#FFCB6B;">incus</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">config</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">device</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">override</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">winvm</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">$DEV</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ipv4.address=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">$FREE_IP</span><span style="color:#89DDFF;">&quot;</span></span></code></pre></div><h2 id="启动虚拟机并通过浏览器远程访问桌面" tabindex="-1">启动虚拟机并通过浏览器远程访问桌面 <a class="header-anchor" href="#启动虚拟机并通过浏览器远程访问桌面" aria-label="Permalink to &quot;启动虚拟机并通过浏览器远程访问桌面&quot;">​</a></h2><p>安装浏览器访问所需组件</p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">apt</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">update</span></span>
<span class="line"><span style="color:#FFCB6B;">apt</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">install</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-y</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">spice-html5</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">websockify</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">lsof</span></span></code></pre></div><p>启动虚拟机</p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">incus</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">start</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">winvm</span></span></code></pre></div><p>无问题后启动远程访问的组件</p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">SERVER_IP</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">$(</span><span style="color:#FFCB6B;">hostname</span><span style="color:#C3E88D;"> -I </span><span style="color:#89DDFF;">|</span><span style="color:#C3E88D;"> </span><span style="color:#FFCB6B;">awk</span><span style="color:#C3E88D;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">{print $1}</span><span style="color:#89DDFF;">&#39;)</span></span>
<span class="line"><span style="color:#FFCB6B;">nohup</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">websockify</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--web</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/usr/share/spice-html5</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">6080</span><span style="color:#A6ACCD;"> \\</span></span>
<span class="line"><span style="color:#A6ACCD;">         </span><span style="color:#C3E88D;">--unix-target=/run/incus/winvm/qemu.spice</span><span style="color:#A6ACCD;"> \\</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/var/log/websockify-winvm.log</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">2&gt;&amp;1</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;</span></span>
<span class="line"><span style="color:#82AAFF;">echo</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">SPICE HTML5 console on http://</span><span style="color:#89DDFF;">\${</span><span style="color:#A6ACCD;">SERVER_IP</span><span style="color:#89DDFF;">}</span><span style="color:#C3E88D;">:6080/spice_auto.html</span><span style="color:#89DDFF;">&quot;</span></span></code></pre></div><p>浏览器打开输出提示的地址</p><p>首次启动需要按浏览器页面左上角的<code>Ctrl+Alt+Delete</code>按钮，重启后在默认的界面按照提示，按回车等待5~10分钟才会正式装载ISO进行实际的安装</p><p>最终会显示Zabbly的图标，这个图标在这里转圈圈需要至少2分钟，请耐心等待。</p><p><img src="`+p+'" alt=""></p><p>转圈圈完毕就会进入正常的Win虚拟机安装流程，类比PVE的操作即可。</p><p><img src="'+o+'" alt=""></p><p><img src="'+e+'" alt=""></p><p><img src="'+t+`" alt=""></p><p>如果已经安装完成(执行到蓝屏，鼠标卡住不能动了，等待超过5分钟)，先关闭/退出Windows(在浏览器上关机)，然后移除 ISO 设备，保证下次从硬盘启动</p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">incus</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">stop</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">winvm</span></span>
<span class="line"><span style="color:#FFCB6B;">incus</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">config</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">device</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">remove</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">winvm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">install</span></span>
<span class="line"><span style="color:#FFCB6B;">incus</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">start</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">winvm</span></span></code></pre></div><h2 id="删除远程组件重新启动浏览器映射" tabindex="-1">删除远程组件重新启动浏览器映射 <a class="header-anchor" href="#删除远程组件重新启动浏览器映射" aria-label="Permalink to &quot;删除远程组件重新启动浏览器映射&quot;">​</a></h2><p>如果发现资源没给够等原因需要删虚拟机重新开设，那么需要使用<code>pkill -f websockify</code>终止所有的spice信号转发，然后<code>incus delete -f winvm</code>强行删除虚拟机。</p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">lsof</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-i</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">:6080</span></span></code></pre></div><p>查询对应端口的PID号是否还存在，确保已完全停止(如果你有多个虚拟机的信号转发，那么最好不要用<code>pkill</code>删除所有，用<code>kill -9</code>删除对应端口的PID即可)。</p><h2 id="如果首次启动没过几分钟就崩溃停机了" tabindex="-1">如果首次启动没过几分钟就崩溃停机了 <a class="header-anchor" href="#如果首次启动没过几分钟就崩溃停机了" aria-label="Permalink to &quot;如果首次启动没过几分钟就崩溃停机了&quot;">​</a></h2><p>需要添加CPU直通</p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">incus</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">config</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">set</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">winvm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">raw.qemu</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">-cpu host</span><span style="color:#89DDFF;">&quot;</span></span></code></pre></div><p>再次启动虚拟机即可</p><h2 id="缺点" tabindex="-1">缺点 <a class="header-anchor" href="#缺点" aria-label="Permalink to &quot;缺点&quot;">​</a></h2><p>前端无权限校验，没法设置用户密码</p><p>如果需要前端鉴权，那么得使用<code>Guacamole</code>添加一些设置来实现，这里就不赘述了</p><p>虚拟机这块没有成型的一些交互面板和适配，<code>spice</code>太古老了</p>`,50),C=[r];function y(D,i,A,F,d,E){return n(),a("div",null,C)}const m=s(c,[["render",y]]);export{h as __pageData,m as default};
