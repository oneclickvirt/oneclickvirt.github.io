import{_ as s,v as n,b as a,R as e}from"./chunks/framework.70afa331.js";const o="/assets/win1.7d3fc058.png",l="/assets/win2.72bb0e48.jpg",t="/assets/win3.442eb15f.jpg",p="/assets/win4.75bd03c1.jpg",r="/assets/win5.58c1b996.jpg",c="/assets/win6.f4215c61.jpg",i="/assets/win7.854d0e0a.jpg",E=JSON.parse('{"title":"Running Windows Virtual Machines in Incus","description":"","frontmatter":{},"headers":[],"relativePath":"en/guide/incus/incus_windows.md","filePath":"en/guide/incus/incus_windows.md","lastUpdated":1747789965000}'),C={name:"en/guide/incus/incus_windows.md"},y=e(`<h1 id="running-windows-virtual-machines-in-incus" tabindex="-1">Running Windows Virtual Machines in Incus <a class="header-anchor" href="#running-windows-virtual-machines-in-incus" aria-label="Permalink to &quot;Running Windows Virtual Machines in Incus&quot;">​</a></h1><h2 id="verify-the-incus-driver" tabindex="-1">Verify the Incus Driver <a class="header-anchor" href="#verify-the-incus-driver" aria-label="Permalink to &quot;Verify the Incus Driver&quot;">​</a></h2><p>Ensure that <code>incus info</code> output contains <code>qemu</code>, otherwise you cannot create VMs:</p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">incus</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">info</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">grep</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-i</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">driver:</span></span></code></pre></div><p>If it only shows <code>lxc</code>, no need to read the subsequent tutorials, incus drivers don&#39;t support opening a VM.</p><h2 id="prepare-the-environment-and-patch-the-image" tabindex="-1">Prepare the Environment and Patch the Image <a class="header-anchor" href="#prepare-the-environment-and-patch-the-image" aria-label="Permalink to &quot;Prepare the Environment and Patch the Image&quot;">​</a></h2><p>Execute the following commands in sequence in the <code>/root</code> directory:</p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">apt</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">update</span></span>
<span class="line"><span style="color:#FFCB6B;">apt</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">install</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-y</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">snapd</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">libguestfs-tools</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">wimtools</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">rsync</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">libhivex-bin</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">libwin-hivex-perl</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">genisoimage</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">||</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">apt</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">install</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-y</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">mkisofs</span></span>
<span class="line"><span style="color:#FFCB6B;">snap</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">install</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">distrobuilder</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--classic</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># reboot to load some config</span></span>
<span class="line"><span style="color:#FFCB6B;">reboot</span></span></code></pre></div><p>Download the image and apply the patch. If you&#39;re using a different image, replace the download link accordingly.</p><p>(You don&#39;t need to download the image that comes with virtio, the original image will suffice)</p><p>Windows image download link: <a href="https://down.idc.wiki/ISOS/Windows/" target="_blank" rel="noreferrer">https://down.idc.wiki/ISOS/Windows/</a></p><p>Supported Windows image versions for patching: <a href="https://linuxcontainers.org/distrobuilder/docs/latest/tutorials/use/#repack-windows-iso" target="_blank" rel="noreferrer">https://linuxcontainers.org/distrobuilder/docs/latest/tutorials/use/#repack-windows-iso</a></p><p>The following guide will use Windows 2019 as an example:</p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">wget</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">https://down.idc.wiki/ISOS/Windows/Server%202019/cn_windows_server_2019_updated_july_2020_x64_dvd_2c9b67da.iso</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-O</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">win.iso</span></span>
<span class="line"><span style="color:#FFCB6B;">distrobuilder</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">repack-windows</span><span style="color:#A6ACCD;"> \\</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">--windows-arch=amd64</span><span style="color:#A6ACCD;"> \\</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">win.iso</span><span style="color:#A6ACCD;"> \\</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">win.incus.iso</span></span></code></pre></div><p>The patching time depends on when the program adds the drivers needed for booting (it will add one by one until successful).</p><p>Some may take a short time, others may take longer, potentially exceeding 10~30 minutes. It&#39;s recommended to run this in <code>screen</code> or <code>tmux</code>.</p><p>After patching is complete, you can delete the original image:</p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">rm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-f</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">win.iso</span></span></code></pre></div><h2 id="create-the-vm-and-mount-the-installation-iso" tabindex="-1">Create the VM and Mount the Installation ISO <a class="header-anchor" href="#create-the-vm-and-mount-the-installation-iso" aria-label="Permalink to &quot;Create the VM and Mount the Installation ISO&quot;">​</a></h2><p>Here I&#39;m using a configuration of 3 CPUs, 5GB RAM, and 30GB storage. If you&#39;re using Windows 10 or newer versions, you&#39;ll need at least 4 CPUs, 6GB RAM, and 40GB storage.</p><p>It&#39;s recommended to use more CPU and RAM than the resources I have set up now to avoid the system getting stuck to the point of crashing.</p><p>If you don&#39;t have enough memory, we recommend checking the Add SWAP item in the Other Useful Items section of this guide to add more virtual memory on your own.</p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;"># Initialize empty VM</span></span>
<span class="line"><span style="color:#FFCB6B;">incus</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">init</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">winvm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--empty</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--vm</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># Adjust root disk size, CPU, and memory</span></span>
<span class="line"><span style="color:#FFCB6B;">incus</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">config</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">device</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">override</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">winvm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">root</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">size=</span><span style="color:#F78C6C;">30</span><span style="color:#C3E88D;">GiB</span></span>
<span class="line"><span style="color:#FFCB6B;">incus</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">config</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">set</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">winvm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">limits.cpu=</span><span style="color:#F78C6C;">3</span></span>
<span class="line"><span style="color:#FFCB6B;">incus</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">config</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">set</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">winvm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">limits.memory=</span><span style="color:#F78C6C;">5</span><span style="color:#C3E88D;">GiB</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># Add TPM device (for Secure Boot/BitLocker support)</span></span>
<span class="line"><span style="color:#FFCB6B;">incus</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">config</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">device</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">add</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">winvm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">vtpm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">tpm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">path=/dev/tpm0</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># Mount installation ISO and set as first boot device</span></span>
<span class="line"><span style="color:#FFCB6B;">incus</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">config</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">device</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">add</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">winvm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">install</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">disk</span><span style="color:#A6ACCD;"> \\</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">source=/root/win.incus.iso</span><span style="color:#A6ACCD;"> \\</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">boot.priority=</span><span style="color:#F78C6C;">10</span></span></code></pre></div><h2 id="start-the-vm-and-access-the-desktop-remotely-via-browser" tabindex="-1">Start the VM and Access the Desktop Remotely via Browser <a class="header-anchor" href="#start-the-vm-and-access-the-desktop-remotely-via-browser" aria-label="Permalink to &quot;Start the VM and Access the Desktop Remotely via Browser&quot;">​</a></h2><p>Install the components needed for browser access:</p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">apt</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">update</span></span>
<span class="line"><span style="color:#FFCB6B;">apt</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">install</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-y</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">spice-html5</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">websockify</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">lsof</span></span></code></pre></div><p>Start the VM:</p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">incus</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">start</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">winvm</span></span></code></pre></div><p>Start remote access components:</p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">SERVER_IP</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">$(</span><span style="color:#FFCB6B;">hostname</span><span style="color:#C3E88D;"> -I </span><span style="color:#89DDFF;">|</span><span style="color:#C3E88D;"> </span><span style="color:#FFCB6B;">awk</span><span style="color:#C3E88D;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">{print $1}</span><span style="color:#89DDFF;">&#39;)</span></span>
<span class="line"><span style="color:#FFCB6B;">nohup</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">websockify</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--web</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/usr/share/spice-html5</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">6080</span><span style="color:#A6ACCD;"> \\</span></span>
<span class="line"><span style="color:#A6ACCD;">         </span><span style="color:#C3E88D;">--unix-target=/run/incus/winvm/qemu.spice</span><span style="color:#A6ACCD;"> \\</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/var/log/websockify-winvm.log</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">2&gt;&amp;1</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;</span></span>
<span class="line"><span style="color:#82AAFF;">echo</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">SPICE HTML5 console on http://</span><span style="color:#89DDFF;">\${</span><span style="color:#A6ACCD;">SERVER_IP</span><span style="color:#89DDFF;">}</span><span style="color:#C3E88D;">:6080/spice_auto.html</span><span style="color:#89DDFF;">&quot;</span></span></code></pre></div><p>At the first boot, you&#39;ll need to press the <code>Ctrl+Alt+Delete</code> button in the upper left corner of the browser page. After restarting, follow the prompts on the default interface. You&#39;ll need to wait 5-10 minutes for the ISO to be loaded for the actual installation.</p><p>Eventually, the Zabbly icon will appear and spin for at least 2 minutes. Please be patient.</p><p><img src="`+o+'" alt=""></p><p>Once the spinning stops, you&#39;ll enter the normal Windows VM installation process, similar to PVE operations.</p><p><img src="'+l+'" alt=""></p><p><img src="'+t+'" alt=""></p><p><img src="'+p+`" alt=""></p><p>If the installation is complete(Execute to blue screen, mouse stuck and can&#39;t move, wait more than 5 minutes), first shut down/exit Windows (from the browser), then remove the ISO device to ensure it boots from the hard disk next time:</p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">incus</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">stop</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">winvm</span></span>
<span class="line"><span style="color:#FFCB6B;">incus</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">config</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">device</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">remove</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">winvm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">install</span></span>
<span class="line"><span style="color:#FFCB6B;">incus</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">start</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">winvm</span></span></code></pre></div><p>The following image can be seen after startup</p><p><img src="`+r+'" alt=""></p><p><img src="'+c+'" alt=""></p><p><img src="'+i+'" alt=""></p><p>No need to configure your own network, incus will automatically assign IPV4 addresses and connect to the network.</p><h2 id="remove-the-remote-component-to-restart-the-browser-mapping" tabindex="-1">Remove the remote component to restart the browser mapping <a class="header-anchor" href="#remove-the-remote-component-to-restart-the-browser-mapping" aria-label="Permalink to &quot;Remove the remote component to restart the browser mapping&quot;">​</a></h2><p>If you need to delete the VM and recreate it due to resource limitations or other reasons, use <code>pkill -f websockify</code> to terminate all SPICE signal forwarding, then <code>incus delete -f winvm</code> to forcibly delete the VM.</p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">lsof</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-i</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">:6080</span></span></code></pre></div><p>Check if the PID for the corresponding port still exists to ensure it has completely stopped (if you have signal forwarding for multiple VMs, it&#39;s better not to use <code>pkill</code> to delete all of them; use <code>kill -9</code> to delete the PID for the specific port).</p><h2 id="if-it-crashes-and-stops-within-a-few-minutes-of-first-startup" tabindex="-1">If it crashes and stops within a few minutes of first startup <a class="header-anchor" href="#if-it-crashes-and-stops-within-a-few-minutes-of-first-startup" aria-label="Permalink to &quot;If it crashes and stops within a few minutes of first startup&quot;">​</a></h2><p>Need to add CPU passthrough</p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">incus</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">config</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">set</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">winvm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">raw.qemu</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">-cpu host</span><span style="color:#89DDFF;">&quot;</span></span></code></pre></div><p>Just start the virtual machine again</p><h2 id="disadvantages" tabindex="-1">Disadvantages <a class="header-anchor" href="#disadvantages" aria-label="Permalink to &quot;Disadvantages&quot;">​</a></h2><p>The frontend lacks authentication, so you can&#39;t set user passwords.</p><p>If you need frontend authentication, you&#39;ll need to use <code>Guacamole</code> with additional settings to implement it, which won&#39;t be covered in detail here.</p><p>The VM piece doesn&#39;t have some well established interactive panels and adaptations, <code>spice</code> is too <a href="https://docs.redhat.com/en/documentation/red_hat_enterprise_linux/9/html/considerations_in_adopting_rhel_9/index" target="_blank" rel="noreferrer">old</a> (although there is a web-based spice client), and the official panels don&#39;t support rbac with a username and password and can only be used with certificates.</p>',56),d=[y];function h(D,u,A,m,g,w){return n(),a("div",null,d)}const v=s(C,[["render",h]]);export{E as __pageData,v as default};
