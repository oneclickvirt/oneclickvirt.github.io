import{_ as s,v as n,b as a,R as l}from"./chunks/framework.70afa331.js";const d=JSON.parse('{"title":"","description":"","frontmatter":{},"headers":[],"relativePath":"guide/incus/incus_windows.md","filePath":"guide/incus/incus_windows.md","lastUpdated":1747666128000}'),p={name:"guide/incus/incus_windows.md"},o=l(`<h3 id="准备环境" tabindex="-1">准备环境 <a class="header-anchor" href="#准备环境" aria-label="Permalink to &quot;准备环境&quot;">​</a></h3><p>在 <code>/root</code> 目录下按顺序执行以下命令：</p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;"># 安装基础工具</span></span>
<span class="line"><span style="color:#FFCB6B;">apt</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">update</span></span>
<span class="line"><span style="color:#FFCB6B;">apt</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">install</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-y</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">snapd</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">libguestfs-tools</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">wimtools</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">rsync</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">libhivex-bin</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">libwin-hivex-perl</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">genisoimage</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">||</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">apt</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">install</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-y</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">mkisofs</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 安装 distrobuilder（用于打包 Windows ISO）</span></span>
<span class="line"><span style="color:#FFCB6B;">snap</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">install</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">distrobuilder</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--classic</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 下载原版 Windows Server 2022 ISO</span></span>
<span class="line"><span style="color:#FFCB6B;">wget</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">https://down.idc.wiki/ISOS/Windows/Server%202022/zh-cn_windows_server_2022_x64_dvd_6c73507d.iso</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 使用 distrobuilder 重新打包为 Incus 支持的 ISO</span></span>
<span class="line"><span style="color:#FFCB6B;">distrobuilder</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">repack-windows</span><span style="color:#A6ACCD;"> \\</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">--windows-arch=amd64</span><span style="color:#A6ACCD;"> \\</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">zh-cn_windows_server_2022_x64_dvd_6c73507d.iso</span><span style="color:#A6ACCD;"> \\</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">zh-cn_windows_server_2022_x64_dvd_6c73507d.incus.iso</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 清理原 ISO</span></span>
<span class="line"><span style="color:#FFCB6B;">rm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-f</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">zh-cn_windows_server_2022_x64_dvd_6c73507d.iso</span></span></code></pre></div><h3 id="检查-incus-驱动" tabindex="-1">检查 Incus 驱动 <a class="header-anchor" href="#检查-incus-驱动" aria-label="Permalink to &quot;检查 Incus 驱动&quot;">​</a></h3><p>确保 <code>incus info</code> 输出中含有 <code>driver: qemu</code>，否则无法创建 VM：</p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">incus</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">info</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">grep</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-i</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">driver:</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 正确示例：</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># driver: qemu</span></span></code></pre></div><p>若显示 <code>driver: lxc</code>，请在 <code>/etc/incus/daemon.conf</code> 中调整为 <code>driver = qemu</code> 并重启 Incus 服务。</p><h3 id="_1-创建-vm-并挂载安装-iso" tabindex="-1">1. 创建 VM 并挂载安装 ISO <a class="header-anchor" href="#_1-创建-vm-并挂载安装-iso" aria-label="Permalink to &quot;1. 创建 VM 并挂载安装 ISO&quot;">​</a></h3><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;"># 初始化空 VM</span></span>
<span class="line"><span style="color:#FFCB6B;">incus</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">init</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">win22vm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--empty</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--vm</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 调整根盘大小、CPU、内存</span></span>
<span class="line"><span style="color:#FFCB6B;">incus</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">config</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">device</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">override</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">win22vm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">root</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">size=</span><span style="color:#F78C6C;">30</span><span style="color:#C3E88D;">GiB</span></span>
<span class="line"><span style="color:#FFCB6B;">incus</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">config</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">set</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">win22vm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">limits.cpu=</span><span style="color:#F78C6C;">3</span></span>
<span class="line"><span style="color:#FFCB6B;">incus</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">config</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">set</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">win22vm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">limits.memory=</span><span style="color:#F78C6C;">4</span><span style="color:#C3E88D;">GiB</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 添加 TPM 设备（Secure Boot/BitLocker 支持）</span></span>
<span class="line"><span style="color:#FFCB6B;">incus</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">config</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">device</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">add</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">win22vm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">vtpm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">tpm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">path=/dev/tpm0</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 挂载安装 ISO，设为第一启动项</span></span>
<span class="line"><span style="color:#FFCB6B;">incus</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">config</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">device</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">add</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">win22vm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">install</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">disk</span><span style="color:#A6ACCD;"> \\</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">source=/root/zh-cn_windows_server_2022_x64_dvd_6c73507d.incus.iso</span><span style="color:#A6ACCD;"> \\</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">boot.priority=</span><span style="color:#F78C6C;">10</span></span></code></pre></div><h3 id="启动-vm-并通过-spice-html5-浏览器安装" tabindex="-1">启动 VM 并通过 SPICE+HTML5 浏览器安装 <a class="header-anchor" href="#启动-vm-并通过-spice-html5-浏览器安装" aria-label="Permalink to &quot;启动 VM 并通过 SPICE+HTML5 浏览器安装&quot;">​</a></h3><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;"># 安装浏览器访问所需组件</span></span>
<span class="line"><span style="color:#FFCB6B;">apt</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">update</span></span>
<span class="line"><span style="color:#FFCB6B;">apt</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">install</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-y</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">spice-html5</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">websockify</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 启动 VM（此时 VM 会自动使用 Spice 输出）</span></span>
<span class="line"><span style="color:#FFCB6B;">incus</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">start</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">win22vm</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">#incus console win22vm --type=vga</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 启动 WebSocket 代理，将 Spice Socket 转为 WebSocket</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 使用 hostname -I 取第一个 IP，供提示使用</span></span>
<span class="line"><span style="color:#A6ACCD;">SERVER_IP</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">$(</span><span style="color:#FFCB6B;">hostname</span><span style="color:#C3E88D;"> -I </span><span style="color:#89DDFF;">|</span><span style="color:#C3E88D;"> </span><span style="color:#FFCB6B;">awk</span><span style="color:#C3E88D;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">{print $1}</span><span style="color:#89DDFF;">&#39;)</span></span>
<span class="line"><span style="color:#FFCB6B;">nohup</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">websockify</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--web</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/usr/share/spice-html5</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">6080</span><span style="color:#A6ACCD;"> \\</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">--unix-target=/run/incus/win22vm/qemu.spice</span><span style="color:#A6ACCD;"> \\</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/var/log/websockify-win22vm.log</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">2&gt;&amp;1</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 输出访问提示</span></span>
<span class="line"><span style="color:#82AAFF;">echo</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">请在浏览器中访问：</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#82AAFF;">echo</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">    https://</span><span style="color:#89DDFF;">\${</span><span style="color:#A6ACCD;">SERVER_IP</span><span style="color:#89DDFF;">}</span><span style="color:#C3E88D;">:6080/spice_auto.html?port=6080</span><span style="color:#89DDFF;">&quot;</span></span></code></pre></div><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;"># 安装完成后，先在控制台关闭/退出 Windows，</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 然后移除 ISO 设备，保证下次从硬盘启动</span></span>
<span class="line"><span style="color:#FFCB6B;">incus</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">config</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">device</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">remove</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">win22vm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">install</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 再次启动 VM</span></span>
<span class="line"><span style="color:#FFCB6B;">incus</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">start</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">win22vm</span></span></code></pre></div><h3 id="在浏览器中访问" tabindex="-1">在浏览器中访问 <a class="header-anchor" href="#在浏览器中访问" aria-label="Permalink to &quot;在浏览器中访问&quot;">​</a></h3><ol><li>打开浏览器，访问 <code>https://&lt;上面获取的 SERVER_IP&gt;:6080/spice_auto.html?port=6080</code></li><li>你将看到 Windows 安装或已安装系统的 SPICE 界面，无需额外客户端。</li></ol>`,14),e=[o];function c(t,r,C,i,y,D){return n(),a("div",null,e)}const E=s(p,[["render",c]]);export{d as __pageData,E as default};
