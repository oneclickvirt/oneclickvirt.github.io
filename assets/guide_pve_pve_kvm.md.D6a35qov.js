import{_ as i,c as a,o as t,ag as l}from"./chunks/framework.CSeR4K32.js";const c=JSON.parse('{"title":"Linux虚拟机(KVM/TCG)","description":"","frontmatter":{"outline":"deep"},"headers":[],"relativePath":"guide/pve/pve_kvm.md","filePath":"guide/pve/pve_kvm.md","lastUpdated":1748518058000}'),h={name:"guide/pve/pve_kvm.md"};function e(p,s,n,d,k,r){return t(),a("div",null,s[0]||(s[0]=[l(`<h1 id="linux虚拟机-kvm-tcg" tabindex="-1">Linux虚拟机(KVM/TCG) <a class="header-anchor" href="#linux虚拟机-kvm-tcg" aria-label="Permalink to &quot;Linux虚拟机(KVM/TCG)&quot;">​</a></h1><h2 id="ssh登录说明" tabindex="-1">SSH登录说明 <a class="header-anchor" href="#ssh登录说明" aria-label="Permalink to &quot;SSH登录说明&quot;">​</a></h2><p>开设出的虚拟机，默认生成的用户名<strong>可以不是</strong><code>root</code>，此时你需要执行<code>sudo -i</code>切换为root用户</p><p>默认设置的用户名<strong>不是<code>root</code>时，未经过设置的默认的root密码是<code>password</code>或<code>oneclickvirt</code></strong></p><p><strong>登录SSH切换为root权限后，一定要修改root密码</strong>，可以使用以下命令修改</p><p>国际</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">bash</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &lt;(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -sSL</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://raw.githubusercontent.com/fscarmen/tools/main/root.sh)</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [PASSWORD]</span></span></code></pre></div><p>国内</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">bash</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &lt;(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -sSL</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://cdn.spiritlhl.net/https://raw.githubusercontent.com/fscarmen/tools/main/root.sh)</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [PASSWORD]</span></span></code></pre></div><h2 id="开设带ipv6地址的虚拟机的注意事项" tabindex="-1">开设带IPV6地址的虚拟机的注意事项 <a class="header-anchor" href="#开设带ipv6地址的虚拟机的注意事项" aria-label="Permalink to &quot;开设带IPV6地址的虚拟机的注意事项&quot;">​</a></h2><p>由于长期闲置IPV6不使用可能导致NDP广播缓存失效重置，一般闲置50分钟左右就会出现IPV6不可用的情况，俗称“IPV6断流”，此时需要设置一个定时任务</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;*/1 * * * * curl -m 6 -s ipv6.ip.sb || curl -m 6 -s ipv6.ip.sb&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> crontab</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> -</span></span></code></pre></div><p>在开设出的虚拟机中执行上述命令，可保证IPV6网络一直被使用，不会失效断流</p><h2 id="开设虚拟机可使用的镜像" tabindex="-1">开设虚拟机可使用的镜像 <a class="header-anchor" href="#开设虚拟机可使用的镜像" aria-label="Permalink to &quot;开设虚拟机可使用的镜像&quot;">​</a></h2><ul><li>已预安装开启cloudinit</li><li>开启SSH登陆</li><li>预设置SSH监听V4和V6的22端口</li><li>开启允许密码验证登陆</li><li>开启允许root登陆</li><li>部分预安装Qemu-guest-agent</li><li>系统支持： <ul><li>x86_64架构的详见 <a href="https://github.com/oneclickvirt/pve_kvm_images" target="_blank" rel="noreferrer">pve_kvm_images</a> 或 <a href="https://github.com/oneclickvirt/kvm_images" target="_blank" rel="noreferrer">kvm_images</a> 中列出的系统，使用时只需要写系统名字+系统版本号，如ubuntu20、ubutnu22、debian11、debian12这种</li><li>arm架构的详见 <a href="http://cloud-images.ubuntu.com/" target="_blank" rel="noreferrer">ubuntu</a> 或 <a href="https://cloud.debian.org/" target="_blank" rel="noreferrer">debian</a> 中列出的系统，使用时只需要写系统名字+系统版本号，如ubuntu20、ubutnu22、debian11、debian12这种</li></ul></li></ul><h2 id="单独开设nat的虚拟化的虚拟机" tabindex="-1">单独开设NAT的虚拟化的虚拟机 <a class="header-anchor" href="#单独开设nat的虚拟化的虚拟机" aria-label="Permalink to &quot;单独开设NAT的虚拟化的虚拟机&quot;">​</a></h2><ul><li>自动开设NAT服务器，默认使用Debian10镜像，因为该镜像占用最小</li><li>可在命令中自定义需要使用的镜像，这里有给出配置好的镜像，镜像自带空间设置是2~10G硬盘，日常使用<strong>至少10G以上</strong>即可，除非某些镜像开不起来再增加硬盘大小</li><li>可在命令中指定存储盘位置，默认不指定时为local盘即系统盘，可指定为PVE中显示的挂载盘</li><li>自定义内存大小推荐512MB内存</li><li>自动进行内外网端口映射，含22，80，443端口以及其他25个内外网端口号一样的端口</li><li>生成后需要等待一段时间虚拟机内部的cloud-init配置好网络以及登陆信息，大概需要5分钟</li><li>虚拟机的相关信息将会存储到WEB端对应VM的NOTES中，可在WEB端查看</li><li>如果宿主机自带IPV6子网将自动附加上IPV6网络，但无公网IPV6地址</li><li>可选择是否开启独立IPV6，需要宿主机至少有一个/104的子网，最好是/64的子网</li></ul><h3 id="使用方法" tabindex="-1">使用方法 <a class="header-anchor" href="#使用方法" aria-label="Permalink to &quot;使用方法&quot;">​</a></h3><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>注意这里的用户名不能是纯数字，会造成cloudinit出问题，最好是纯英文或英文开头</p></div><p><strong>下载脚本</strong></p><p>国际</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -L</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://raw.githubusercontent.com/oneclickvirt/pve/main/scripts/buildvm.sh</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> buildvm.sh</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &amp;&amp; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">chmod</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> +x</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> buildvm.sh</span></span></code></pre></div><p>国内</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -L</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://cdn.spiritlhl.net/https://raw.githubusercontent.com/oneclickvirt/pve/main/scripts/buildvm.sh</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> buildvm.sh</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &amp;&amp; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">chmod</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> +x</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> buildvm.sh</span></span></code></pre></div><p><strong>各参数含义</strong></p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># ./buildvm.sh VMID 用户名 密码 CPU核数 内存 硬盘 SSH端口 80端口 443端口 外网端口起 外网端口止 系统 存储盘 独立IPV6地址(留空默认N)</span></span></code></pre></div><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>注意这里的密码最好仅英文与数字混合，且以英文开头，避免密码在设置过程中因为特殊字符被转义而设置失败</p></div><h3 id="测试示例" tabindex="-1">测试示例 <a class="header-anchor" href="#测试示例" aria-label="Permalink to &quot;测试示例&quot;">​</a></h3><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./buildvm.sh</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 111</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> root</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> oneclick123</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 512</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 10</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 40001</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 40002</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 40003</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 50000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 50025</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> debian11</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> local</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> N</span></span></code></pre></div><p>开设完毕可执行<code>cat vm111</code>查看信息，或到WEB端对应VM的NOTES中查看</p><p>以下为开设的示例VM的信息：</p><table tabindex="0"><thead><tr><th>属性</th><th>值</th></tr></thead><tbody><tr><td>VMID</td><td>111</td></tr><tr><td>SSH登录的用户名</td><td>root</td></tr><tr><td>SSH登录的密码</td><td>oneclick123</td></tr><tr><td>CPU核数</td><td>1</td></tr><tr><td>内存大小</td><td>512MB</td></tr><tr><td>磁盘大小</td><td>10G</td></tr><tr><td>SSH端口</td><td>40001</td></tr><tr><td>80端口</td><td>40002</td></tr><tr><td>443端口</td><td>40003</td></tr><tr><td>内外网映射端口一致的区间</td><td>50000到50025</td></tr><tr><td>系统</td><td>debian11</td></tr><tr><td>宿主机的存储盘</td><td>local</td></tr><tr><td>绑定独立IPV6(留空默认N)</td><td>N</td></tr></tbody></table><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>注意这里的VMID仅可使用100到256，其他数字不可用</p></div><h2 id="删除指定虚拟机" tabindex="-1">删除指定虚拟机 <a class="header-anchor" href="#删除指定虚拟机" aria-label="Permalink to &quot;删除指定虚拟机&quot;">​</a></h2><ul><li>停止VM</li><li>删除VM</li><li>删除端口映射</li><li>重启网络</li><li>删除log文件</li></ul><p><strong>下载脚本</strong></p><p>国际</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -L</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://raw.githubusercontent.com/oneclickvirt/pve/main/scripts/pve_delete.sh</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> pve_delete.sh</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &amp;&amp; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">chmod</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> +x</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> pve_delete.sh</span></span></code></pre></div><p>国内</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -L</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://cdn.spiritlhl.net/https://raw.githubusercontent.com/oneclickvirt/pve/main/scripts/pve_delete.sh</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> pve_delete.sh</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &amp;&amp; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">chmod</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> +x</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> pve_delete.sh</span></span></code></pre></div><p><strong>使用方法</strong></p><p>可以删除对应VMID的虚拟机，这里用上文中的示例111做演示</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./pve_delete.sh</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 111</span></span></code></pre></div><p>实际删除数量不固定，空格分隔每个VMID即可，可一次性删除多个</p><h2 id="批量开设nat的虚拟化的虚拟机" tabindex="-1">批量开设NAT的虚拟化的虚拟机 <a class="header-anchor" href="#批量开设nat的虚拟化的虚拟机" aria-label="Permalink to &quot;批量开设NAT的虚拟化的虚拟机&quot;">​</a></h2><div class="warning custom-block"><p class="custom-block-title">WARNING</p><p>初次使用前需要保证当前PVE纯净且宿主机未进行过任何端口映射，否则设置冲突可能出现BUG</p></div><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>开设前请使用screen挂起执行，避免批量开设时间过长，SSH不稳定导致中间执行中断</p></div><ul><li>可多次运行批量生成VM</li><li>自动开设NAT服务器，选项留空默认使用debian11镜像，可自定义使用镜像名字，支持的系统名字详见上文支持的镜像列表</li><li>自动进行内外网端口映射，含22，80，443端口以及其他25个内外网端口号一样的端口</li><li>生成后需要等待一段时间虚拟机内部的cloudinit配置好网络以及登陆信息，大概需要5分钟，每个虚拟机创建之间有间隔等待60秒避免突发性能不足</li><li>默认批量开设的虚拟机网络配置为：22，80，443端口及一个25个端口区间的内外网映射</li><li>可自定义批量开设的核心数，内存大小，硬盘大小，使用宿主机哪个存储盘，记得自己计算好空闲资源开设</li><li>虚拟机的相关信息将会存储到WEB端对应VM的NOTES中，可在WEB端查看</li><li>如果宿主机自带IPV6子网将自动附加上IPV6网络，但无公网IPV6地址</li><li>可选择是否开启独立IPV6，需要宿主机至少有一个/104的子网，最好是一个/64子网</li></ul><p>国际</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -L</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://raw.githubusercontent.com/oneclickvirt/pve/main/scripts/create_vm.sh</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> create_vm.sh</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &amp;&amp; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">chmod</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> +x</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> create_vm.sh</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &amp;&amp; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">bash</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> create_vm.sh</span></span></code></pre></div><p>国内</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -L</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://cdn.spiritlhl.net/https://raw.githubusercontent.com/oneclickvirt/pve/main/scripts/create_vm.sh</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> create_vm.sh</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &amp;&amp; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">chmod</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> +x</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> create_vm.sh</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &amp;&amp; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">bash</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> create_vm.sh</span></span></code></pre></div><p>开设完毕可执行<code>cat vmlog</code>查看信息，或到WEB端对应VM的NOTES中查看</p><h2 id="删除所有虚拟机" tabindex="-1">删除所有虚拟机 <a class="header-anchor" href="#删除所有虚拟机" aria-label="Permalink to &quot;删除所有虚拟机&quot;">​</a></h2><ul><li>删除所有VM</li><li>删除所有nat的端口映射</li><li>重启网络</li><li>删除log文件</li></ul><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> vmid </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">qm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> list</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> awk</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;{if(NR&gt;1) print $1}&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">); </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> qm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> stop</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $vmid; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">qm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> destroy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $vmid; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rm</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -rf</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /var/lib/vz/images/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$vmid</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">done</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">iptables</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -t</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> nat</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -F</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">iptables</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -t</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> filter</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -F</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">service</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> networking</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> restart</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> restart</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> networking.service</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> restart</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ndpresponder.service</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">iptables-save</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> awk</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;{if($1==&quot;COMMIT&quot;){delete x}}$1==&quot;-A&quot;?!x[$0]++:1&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> iptables-restore</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">iptables-save</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/iptables/rules.v4</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rm</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -rf</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> vmlog</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rm</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -rf</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> vm</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">*</span></span></code></pre></div><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>PVE修改VM配置前都得停机先，再修改配置，修改完再启动，免得出现配置重载错误</p></div><h2 id="开设独立ipv4地址的虚拟机" tabindex="-1">开设独立IPV4地址的虚拟机 <a class="header-anchor" href="#开设独立ipv4地址的虚拟机" aria-label="Permalink to &quot;开设独立IPV4地址的虚拟机&quot;">​</a></h2><p>三个脚本，各取所需，各有优缺点。</p><p>前两个脚本<strong>不需要</strong>额外的IPV4地址事先绑定到<code>vmbr0</code>接口上，开设的虚拟机将<strong>直接</strong>绑定额外的IPV4地址。</p><p>最后一个脚本<strong>需要</strong>额外的IPV4地址事先绑定到<code>vmbr0</code>接口上，开设的虚拟机将做<strong>NAT全端口映射</strong>内网IPV4地址，<strong>不直接</strong>绑定额外的IPV4地址。</p><h3 id="自动选择宿主机同一子网内的额外ipv4地址开设虚拟机" tabindex="-1">自动选择宿主机同一子网内的额外IPV4地址开设虚拟机 <a class="header-anchor" href="#自动选择宿主机同一子网内的额外ipv4地址开设虚拟机" aria-label="Permalink to &quot;自动选择宿主机同一子网内的额外IPV4地址开设虚拟机&quot;">​</a></h3><div class="warning custom-block"><p class="custom-block-title">WARNING</p><p>使用前需要保证当前宿主机的IP段带了至少2个IP，且有空余的IP未配置，该空余的IP未绑定宿主机。</p></div><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>此时附加的IPV4地址是宿主机目前的IPV4地址顺位后面的地址， 比如目前宿主机地址是<code>1.1.1.32</code>然后<code>1.1.1.33</code>已经有虚拟机了，那么本脚本附加IP地址为<code>1.1.1.34</code></p></div><ul><li>自动检测可用的IP区间，通过ping检测空余可使用的IP，选取其中之一绑定到虚拟机上</li><li>如果宿主机自带IPV6子网将可选择是否附加上IPV6地址</li><li>系统的相关信息将会存储到对应的虚拟机的NOTE中，可在WEB端查看</li><li>自动附加的IPV4地址与宿主机的IPV4地址是在<strong>同一个子网</strong>内的(IP地址前缀相同)</li><li>在虚拟机内外进出流量都走绑定的额外IPV4的地址</li></ul><h4 id="使用方法-1" tabindex="-1">使用方法 <a class="header-anchor" href="#使用方法-1" aria-label="Permalink to &quot;使用方法&quot;">​</a></h4><p><strong>下载脚本</strong></p><p>国际</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -L</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://raw.githubusercontent.com/oneclickvirt/pve/main/scripts/buildvm_extra_ip.sh</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> buildvm_extra_ip.sh</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &amp;&amp; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">chmod</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> +x</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> buildvm_extra_ip.sh</span></span></code></pre></div><p>国内</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -L</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://cdn.spiritlhl.net/https://raw.githubusercontent.com/oneclickvirt/pve/main/scripts/buildvm_extra_ip.sh</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> buildvm_extra_ip.sh</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &amp;&amp; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">chmod</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> +x</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> buildvm_extra_ip.sh</span></span></code></pre></div><p><strong>各参数含义</strong></p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># ./buildvm_extra_ip.sh VMID 用户名 密码 CPU核数 内存大小以MB计算 硬盘大小以GB计算 系统 存储盘 独立IPV6(默认为N)</span></span></code></pre></div><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>注意这里的密码最好仅英文与数字混合，且以英文开头，避免密码在设置过程中因为特殊字符被转义而设置失败</p></div><h4 id="测试示例-1" tabindex="-1">测试示例 <a class="header-anchor" href="#测试示例-1" aria-label="Permalink to &quot;测试示例&quot;">​</a></h4><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./buildvm_extra_ip.sh</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 152</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> root</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> oneclick123</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1024</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 10</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> debian12</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> local</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> N</span></span></code></pre></div><p>上述命令意义为开设一个带独立IPV4地址的虚拟机</p><table tabindex="0"><thead><tr><th>属性</th><th>值</th></tr></thead><tbody><tr><td>VMID</td><td>152</td></tr><tr><td>用户名</td><td>root</td></tr><tr><td>密码</td><td>oneclick123</td></tr><tr><td>CPU</td><td>1核</td></tr><tr><td>内存</td><td>1024MB</td></tr><tr><td>硬盘</td><td>10G</td></tr><tr><td>系统</td><td>debian12</td></tr><tr><td>存储盘</td><td>local盘</td></tr><tr><td>IPV6附加</td><td>默认不附加</td></tr></tbody></table><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>注意这里的VMID仅可使用100到256，其他数字不可用</p></div><h3 id="手动指定额外ipv4地址开设虚拟机" tabindex="-1">手动指定额外IPV4地址开设虚拟机 <a class="header-anchor" href="#手动指定额外ipv4地址开设虚拟机" aria-label="Permalink to &quot;手动指定额外IPV4地址开设虚拟机&quot;">​</a></h3><ul><li>需要手动在命令中指定IPV4地址，且带上子网长度</li><li>如果宿主机自带IPV6子网将可选择是否附加上IPV6地址</li><li>如果商家有给IPV4地址和子网长度，请仔细比对，按照下面示例的命令写参数</li><li>系统的相关信息将会存储到对应的虚拟机的NOTE中，可在WEB端查看</li><li>可选择是否开启独立IPV6，需要宿主机至少有一个/104的子网，最好是一个/64子网</li><li>手动附加的IPV4地址与宿主机的IPV4地址是在<strong>不同子网</strong>内的(IP地址前缀不同)，将使用宿主机IP地址做网关</li><li>手动附加的IPV4地址与宿主机的IPV4地址是在<strong>同一个子网</strong>内的(IP地址前缀相同)，将使用宿主机的网关做网关</li><li>可选择是否指定虚拟机的MAC地址</li><li>在虚拟机内外进出流量都走绑定的额外IPV4的地址</li></ul><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>在<strong>不同子网</strong>内的IP地址，如果附加时不指定MAC地址，那么路由器无法识别源 MAC 地址，流量将被标记为“滥用”，并“可能”导致服务器被阻止。 (如果使用Hetzner的独立服务器务建议提供附加IPV4地址对应的MAC地址防止被报告滥用)</p></div><h4 id="使用方法-2" tabindex="-1">使用方法 <a class="header-anchor" href="#使用方法-2" aria-label="Permalink to &quot;使用方法&quot;">​</a></h4><p><strong>下载脚本</strong></p><p>国际</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -L</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://raw.githubusercontent.com/oneclickvirt/pve/main/scripts/buildvm_manual_ip.sh</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> buildvm_manual_ip.sh</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &amp;&amp; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">chmod</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> +x</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> buildvm_manual_ip.sh</span></span></code></pre></div><p>国内</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -L</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://cdn.spiritlhl.net/https://raw.githubusercontent.com/oneclickvirt/pve/main/scripts/buildvm_manual_ip.sh</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> buildvm_manual_ip.sh</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &amp;&amp; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">chmod</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> +x</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> buildvm_manual_ip.sh</span></span></code></pre></div><p><strong>各参数含义</strong></p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># ./buildvm_manual_ip.sh VMID 用户名 密码 CPU核数 内存大小以MB计算 硬盘大小以GB计算 系统 存储盘 IPV4地址 独立IPV6(默认为N) MAC地址(不提供时将不指定虚拟机的MAC地址)</span></span></code></pre></div><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>注意这里的密码最好仅英文与数字混合，且以英文开头，避免密码在设置过程中因为特殊字符被转义而设置失败</p></div><h4 id="测试示例-2" tabindex="-1">测试示例 <a class="header-anchor" href="#测试示例-2" aria-label="Permalink to &quot;测试示例&quot;">​</a></h4><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./buildvm_manual_ip.sh</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 152</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> root</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> oneclick123</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1024</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 10</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> debian12</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> local</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> a.b.c.d/24</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> N</span></span></code></pre></div><p>上述命令意义为开设一个带独立IPV4地址的虚拟机</p><table tabindex="0"><thead><tr><th>属性</th><th>值</th></tr></thead><tbody><tr><td>VMID</td><td>152</td></tr><tr><td>用户名</td><td>root</td></tr><tr><td>密码</td><td>oneclick123</td></tr><tr><td>CPU</td><td>1核</td></tr><tr><td>内存</td><td>1024MB</td></tr><tr><td>硬盘</td><td>10G</td></tr><tr><td>系统</td><td>debian12</td></tr><tr><td>存储盘</td><td>local盘 (系统盘)</td></tr><tr><td>IPV4地址</td><td>a.b.c.d</td></tr><tr><td>子网</td><td>/24 子网</td></tr><tr><td>IPV6</td><td>无</td></tr><tr><td>MAC地址</td><td>无</td></tr></tbody></table><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>注意这里的VMID仅可使用100到256，其他数字不可用</p></div><h3 id="宿主机手动附加额外ipv4地址后再指定ipv4地址开设虚拟机" tabindex="-1">宿主机手动附加额外IPV4地址后再指定IPV4地址开设虚拟机 <a class="header-anchor" href="#宿主机手动附加额外ipv4地址后再指定ipv4地址开设虚拟机" aria-label="Permalink to &quot;宿主机手动附加额外IPV4地址后再指定IPV4地址开设虚拟机&quot;">​</a></h3><ul><li>需要自己在<code>/etc/network/interfaces</code>中给<code>vmbr0</code>添加额外的IPV4地址(注意<code>chattr -i</code>解锁文件修改后再<code>chattr +i</code>加锁回去)</li><li>其他功能类似开设NAT的虚拟机，只不过这里映射不再是部分端口映射，也不再是映射到宿主机的IPV4地址上，而是全端口一一映射到额外的IPV4地址上</li><li>在虚拟机外进入虚拟机的流量走绑定的额外IPV4的地址，在虚拟机内发出的流量走原有的宿主机的IPV4地址</li></ul><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>务必保证开设前你能使用额外的IPV4地址通过SSH登录宿主机，但<code>curl ip.sb</code>却仍显示原来的宿主机IPV4地址</p></div><h4 id="使用方法-3" tabindex="-1">使用方法 <a class="header-anchor" href="#使用方法-3" aria-label="Permalink to &quot;使用方法&quot;">​</a></h4><p><strong>下载脚本</strong></p><p>国际</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -L</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://raw.githubusercontent.com/oneclickvirt/pve/main/scripts/buildvm_fullnat_ip.sh</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> buildvm_fullnat_ip.sh</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &amp;&amp; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">chmod</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> +x</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> buildvm_fullnat_ip.sh</span></span></code></pre></div><p>国内</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -L</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://cdn.spiritlhl.net/https://raw.githubusercontent.com/oneclickvirt/pve/main/scripts/buildvm_fullnat_ip.sh</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> buildvm_fullnat_ip.sh</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &amp;&amp; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">chmod</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> +x</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> buildvm_fullnat_ip.sh</span></span></code></pre></div><p><strong>各参数含义</strong></p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># ./buildvm_fullnat_ip.sh VMID 用户名 密码 CPU核数 内存大小以MB计算 硬盘大小以GB计算 系统 存储盘 IPV4地址 独立IPV6(默认为N)</span></span></code></pre></div><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>注意这里的密码最好仅英文与数字混合，且以英文开头，避免密码在设置过程中因为特殊字符被转义而设置失败</p></div><h4 id="测试示例-3" tabindex="-1">测试示例 <a class="header-anchor" href="#测试示例-3" aria-label="Permalink to &quot;测试示例&quot;">​</a></h4><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./buildvm_fullnat_ip.sh</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 152</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> root</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> oneclick123</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1024</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 10</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> debian12</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> local</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> a.b.c.d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> N</span></span></code></pre></div><p>上述命令意义为开设一个带独立IPV4地址的虚拟机</p><table tabindex="0"><thead><tr><th>属性</th><th>值</th></tr></thead><tbody><tr><td>VMID</td><td>152</td></tr><tr><td>用户名</td><td>root</td></tr><tr><td>密码</td><td>oneclick123</td></tr><tr><td>CPU</td><td>1核</td></tr><tr><td>内存</td><td>1024MB</td></tr><tr><td>硬盘</td><td>10G</td></tr><tr><td>系统</td><td>debian12</td></tr><tr><td>存储盘</td><td>local盘 (系统盘)</td></tr><tr><td>IPV4地址</td><td>a.b.c.d</td></tr><tr><td>IPV6</td><td>无</td></tr></tbody></table><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>注意这里的VMID仅可使用100到256，其他数字不可用</p></div><h4 id="进出流量都走绑定的ipv4地址" tabindex="-1">进出流量都走绑定的IPV4地址 <a class="header-anchor" href="#进出流量都走绑定的ipv4地址" aria-label="Permalink to &quot;进出流量都走绑定的IPV4地址&quot;">​</a></h4><p>执行</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>line=&quot;-A POSTROUTING -s 172.16.1.0\\/24 -o vmbr0 -j MASQUERADE&quot;</span></span>
<span class="line"><span>sed -i &quot;\\|$line|d&quot; /etc/iptables/rules.v4</span></span>
<span class="line"><span>service netfilter-persistent restart</span></span></code></pre></div><p>即可，但这会导致宿主机丧失开设非独立IPV4地址的NAT的虚拟机/容器的能力，慎重执行</p><p>执行后你只能开设独立IPV4地址的虚拟机了。</p><h2 id="开设纯ipv6地址的虚拟机" tabindex="-1">开设纯IPV6地址的虚拟机 <a class="header-anchor" href="#开设纯ipv6地址的虚拟机" aria-label="Permalink to &quot;开设纯IPV6地址的虚拟机&quot;">​</a></h2><p>前提是宿主机给的是IPV6子网而不是单独一个IPV6地址，且宿主机未开启MAC地址校验</p><h3 id="自动选择ipv6地址无需手动指定" tabindex="-1">自动选择IPV6地址无需手动指定 <a class="header-anchor" href="#自动选择ipv6地址无需手动指定" aria-label="Permalink to &quot;自动选择IPV6地址无需手动指定&quot;">​</a></h3><ul><li>纯IPV6指绑定的公共IPV6地址，实际虚拟机仍旧有宿主机的IPV4网络但无外网IPV4端口</li><li>自动检测可用的IPV6区间，对应虚拟机编号的V6地址绑定到虚拟机上</li><li>系统的相关信息将会存储到对应的虚拟机的NOTE中，可在WEB端查看</li></ul><h4 id="使用方法-4" tabindex="-1">使用方法 <a class="header-anchor" href="#使用方法-4" aria-label="Permalink to &quot;使用方法&quot;">​</a></h4><p><strong>下载脚本</strong></p><p>国际</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -L</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://raw.githubusercontent.com/oneclickvirt/pve/main/scripts/buildvm_onlyv6.sh</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> buildvm_onlyv6.sh</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &amp;&amp; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">chmod</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> +x</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> buildvm_onlyv6.sh</span></span></code></pre></div><p>国内</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -L</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://cdn.spiritlhl.net/https://raw.githubusercontent.com/oneclickvirt/pve/main/scripts/buildvm_onlyv6.sh</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> buildvm_onlyv6.sh</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &amp;&amp; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">chmod</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> +x</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> buildvm_onlyv6.sh</span></span></code></pre></div><p><strong>各参数含义</strong></p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># ./buildvm_onlyv6.sh VMID 用户名 密码 CPU核数 内存大小以MB计算 硬盘大小以GB计算 系统 存储盘</span></span></code></pre></div><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>注意这里的密码最好仅英文与数字混合，且以英文开头，避免密码在设置过程中因为特殊字符被转义而设置失败</p></div><h4 id="创建示例" tabindex="-1">创建示例 <a class="header-anchor" href="#创建示例" aria-label="Permalink to &quot;创建示例&quot;">​</a></h4><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./buildvm_onlyv6.sh</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 152</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> root</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> oneclick123</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1024</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 10</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> debian12</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> local</span></span></code></pre></div><p>上述命令意义为开设一个纯IPV6地址的虚拟机</p><table tabindex="0"><thead><tr><th>参数</th><th>值</th></tr></thead><tbody><tr><td>VMID</td><td>152</td></tr><tr><td>用户名</td><td>root</td></tr><tr><td>密码</td><td>oneclick123</td></tr><tr><td>CPU</td><td>1核</td></tr><tr><td>内存</td><td>1024MB</td></tr><tr><td>硬盘</td><td>10G</td></tr><tr><td>系统</td><td>debian12</td></tr><tr><td>存储盘</td><td>local</td></tr></tbody></table><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>注意这里的VMID仅可使用100到256，其他数字不可用</p></div><h3 id="删除vm152示例" tabindex="-1">删除vm152示例 <a class="header-anchor" href="#删除vm152示例" aria-label="Permalink to &quot;删除vm152示例&quot;">​</a></h3><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">qm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> stop</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 152</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">qm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> destroy</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 152</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> restart</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ndpresponder.service</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rm</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -rf</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> vm152</span></span></code></pre></div>`,138)]))}const F=i(h,[["render",e]]);export{c as __pageData,F as default};
